// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or vendor/assets/javascripts of plugins, if any, can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// the compiled file.
//
// WARNING: THE FIRST BLANK LINE MARKS THE END OF WHAT'S TO BE PROCESSED, ANY BLANK LINE SHOULD
// GO AFTER THE REQUIRES BELOW.
//
//= require jquery
//= require jquery_ujs
//= require bootstrap
//= require bootstrap-modal-responsive-fix

$(document).ready(function(){
	
	$.errorList = function(responseText) {
		var errorList = $('<ul />');
		$.each($.parseJSON(responseText).errors, function(field,errors){
			errorList.append('<li>' + field + ' ' + errors.join(", ") + '</li>');
		});
		errorList.prepend($("<h4>Please correct erros below</h4>"));
		return errorList.html();
	}
		
	$.initEvents = function() {
		// new campaign form	
		$("form#new_campaign[data-remote=true]").
		unbind('ajax:beforeSend').
		on('ajax:beforeSend', function(event, data, status) {
			$(this).find(".alert").remove();
			var submit = $(this).find("button[type=submit]");
			submit.data("val", submit.text()).attr('disabled',true).text('...');
		}).
		unbind('ajax:error').		
		on('ajax:error', function(event, xhr, status) {
			var submit = $(this).find("button[type=submit]");
			// $("body").prepend($("#campaigns_template_error").html().
			// 					replace(/\${message}/, $.errorList(xhr.responseText)));
			var errs = $($("#campaigns_template_error").html().
									replace(/\${message}/, $.errorList(xhr.responseText)));
			errs.insertAfter($(".mainmenu"));								
			submit.removeAttr('disabled').text(submit.data('val'));
		}).
		unbind('ajax:success').				
		on("ajax:success", function(event, data, status) {
			
			var form = $(this);
			var submit = form.find("button[type=submit]");
			submit.removeAttr('disabled').text(submit.data('val'));
			form.find("#campaign_name").val("");
			form.find("#campaign_plan").val("");		
			form.prepend( $( $("#campaigns_template_success").html()).hide().fadeIn() );
		});
	
		// campaign change plan select
		$(".change_campaign_plan").
		unbind("change").
		change(function(){
			var plan = $(this).val();
			var id = $(this).data("id");		
			$.post("/api/campaigns/" + id,{_method: "PUT", campaign: {plan: plan}}, function(data){
				console.log(data);
			});
		});
	
		// campaign change theme select
		$(".change_campaign_theme").
		unbind("change").
		change(function(){
			var theme = $(this).val();
			var id = $(this).data("id");		
			$.post("/api/campaigns/" + id,{_method: "PUT", campaign: {theme: theme}}, function(data){
				console.log(data);
			});
		});
	
		// campaign delete button
		$("a.destroy").
		unbind("ajax:beforeSend").
		on('ajax:beforeSend', function(event, data, status) {
			var a = $(this);
			a.data("text", a.text()).attr('disabled',true).text('...');
		}).
		unbind("ajax:error").		
		on('ajax:error', function(event, xhr, status) {

			var a = $(this);
			var errs = $($("#campaigns_template_error").html().
									replace(/\${message}/, $.errorList(xhr.responseText)));
			errs.insertAfter($(".mainmenu"));
			a.removeAttr('disabled').text(a.data('val'));
		}).
		unbind("ajax:success").				
		on("ajax:success", function(event, data, status) {
			// console.log($(this))
			var tr = $(this).parents("li");
			tr.fadeOut(function () { tr.remove() });
		});
		
		$('a[rel=tooltip]').tooltip();
		$('a[rel=popover]').popover();
	
	}
	
	$.parseCampaignRowTmp = function(campaign) {
		var campaigns_tr = $("#campaigns_template_tr").html(),
				status_classes = {online: "success", deleted: "error", pending: "warning", maintenance: "warning"}
				campaign_class = status_classes[campaign.status];
				
		campaigns_tr = campaigns_tr.
						replace(/\${campaign_class}/g, campaign_class).
						replace(/\${slug}/g, campaign.slug).
						replace(/\${name}/g, campaign.name).
						replace(/\${plan}/g, campaign.plan).
						replace(/\${status}/g, campaign.status).
						replace(/\${price}/g, campaign.price).								
						replace(/\${theme}/g, campaign.theme).																	
						replace(/\${id}/g, campaign.id);
		return 	campaigns_tr;			
	}
	
	$.setCampaignRowStatus = function(tr) {
		if (tr.find(".status").text() != "online") {
			tr.find(".visit").html("...");
			tr.find(".manage").html("...");			
			if (tr.find(".status").text() == "deleted" )
				tr.find(".actions").html('');			
			else
				tr.find(".actions").html('<%= image_tag "ajax-loader.gif" %>');
			tr.find(".change_campaign_plan").parents("span").text(tr.find(".plan").data("plan"));
			tr.find(".change_campaign_theme").parents("span").text(tr.find(".theme").data("theme"));
		}else{
			tr.find(".change_campaign_plan").val(tr.find(".plan").data("plan"));
			tr.find(".change_campaign_theme").val(tr.find(".theme").data("theme"));					
		}
	}
	
	$.updateCampaignRow = function(campaign) {
		
		var campaigns_tr = 	$.parseCampaignRowTmp(campaign);
		
	  $("li#campaign_" + campaign.id).replaceWith(campaigns_tr);
	
		$.setCampaignRowStatus( $("li#campaign_" + campaign.id) );
		
		$.initEvents();		
	}
	
	$.myCampaigns = function() {
			$.get("/api/campaigns", function (data) {

				var campaigns_table = $("#campaigns_template_table").html(),
						list 						= '';

				if (data.length == 0) {
					campaigns_table = "<h1>No apps found</h1>";
				}else{
					for (var i in data) {
						list += $.parseCampaignRowTmp(data[i]);
					}
					campaigns_table = campaigns_table.replace(/\${list}/, list );	
				}

				$(".main").html(campaigns_table);
				
				$("li.campaign").each(function(){
					$.setCampaignRowStatus($(this));
				});

				$.initEvents();
			});
		
	}
	
	$(".navbar a").click(function(){

		var href = $(this).attr("href");
		
		if(!(href.indexOf("#") > -1)) return true;
		
		$(".main").html("<div class=\"loading\"><img src=\"<%= image_path("ajax-loader.gif") %>\"></div>");
		
		switch(href){
			case "#my_campaigns":
			$.myCampaigns();
			break;
			default:
			$(".main").load(href.replace("#",""),function(){
				$.initEvents();
			});
			break;
		}

		return false;
	});

	$.initEvents();	
	
});
